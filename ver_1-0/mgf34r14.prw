#INCLUDE "totvs.ch"  

#DEFINE STR0001 FWI18NLang("MATR480","STR0001",1)
#DEFINE STR0002 FWI18NLang("MATR480","STR0002",2)
#DEFINE STR0003 FWI18NLang("MATR480","STR0003",3)
#DEFINE STR0004 FWI18NLang("MATR480","STR0004",4)
#DEFINE STR0005 FWI18NLang("MATR480","STR0005",5)
#DEFINE STR0006 FWI18NLang("MATR480","STR0006",6)
#DEFINE STR0007 FWI18NLang("MATR480","STR0007",7)
#DEFINE STR0008 FWI18NLang("MATR480","STR0008",8)
#DEFINE STR0009 FWI18NLang("MATR480","STR0009",9)
#DEFINE STR0010 FWI18NLang("MATR480","STR0010",10)
#DEFINE STR0011 FWI18NLang("MATR480","STR0011",11)
#DEFINE STR0012 FWI18NLang("MATR480","STR0012",12)
#DEFINE STR0013 FWI18NLang("MATR480","STR0013",13)
#DEFINE STR0014 FWI18NLang("MATR480","STR0014",14)
#DEFINE STR0015 FWI18NLang("MATR480","STR0015",15)
#DEFINE STR0016 FWI18NLang("MATR480","STR0016",16)
#DEFINE STR0017 FWI18NLang("MATR480","STR0017",17)
#DEFINE STR0018 FWI18NLang("MATR480","STR0018",18)
#DEFINE STR0019 FWI18NLang("MATR480","STR0019",19)
#DEFINE STR0020 FWI18NLang("MATR480","STR0020",20)
#DEFINE STR0021 FWI18NLang("MATR480","STR0021",21)
#DEFINE STR0022 FWI18NLang("MATR480","STR0022",22)
#DEFINE STR0023 FWI18NLang("MATR480","STR0023",23)
#DEFINE STR0024 FWI18NLang("MATR480","STR0024",24)
#DEFINE STR0025 FWI18NLang("MATR480","STR0025",25)
#DEFINE STR0026 FWI18NLang("MATR480","STR0026",26)
#DEFINE STR0027 FWI18NLang("MATR480","STR0027",27)
#DEFINE STR0028 FWI18NLang("MATR480","STR0028",28)
#DEFINE STR0029 FWI18NLang("MATR480","STR0029",29)
#DEFINE STR0030 FWI18NLang("MATR480","STR0030",30)
#DEFINE STR0031 FWI18NLang("MATR480","STR0031",31)
#DEFINE STR0032 FWI18NLang("MATR480","STR0032",32)
#DEFINE STR0033 FWI18NLang("MATR480","STR0033",33)
#DEFINE STR0034 FWI18NLang("MATR480","STR0034",34)
#DEFINE STR0035 FWI18NLang("MATR480","STR0035",35)
#DEFINE STR0036 FWI18NLang("MATR480","STR0036",36)
#DEFINE STR0037 FWI18NLang("MATR480","STR0037",37)
#DEFINE STR0038 FWI18NLang("MATR480","STR0038",38)
#DEFINE STR0039 FWI18NLang("MATR480","STR0039",39)
#DEFINE STR0040 FWI18NLang("MATR480","STR0040",40)
#DEFINE STR0041 FWI18NLang("MATR480","STR0041",41)
#DEFINE STR0042 FWI18NLang("MATR480","STR0042",42)
#DEFINE STR0043 FWI18NLang("MATR480","STR0043",43)
#DEFINE STR0044 FWI18NLang("MATR480","STR0044",44)
#DEFINE STR0045 FWI18NLang("MATR480","STR0045",45)
#DEFINE STR0046 FWI18NLang("MATR480","STR0046",46)
#DEFINE STR0047 FWI18NLang("MATR480","STR0047",47)
#DEFINE STR0048 FWI18NLang("MATR480","STR0048",48)
#DEFINE STR0049 FWI18NLang("MATR480","STR0049",49)
#DEFINE STR0050 FWI18NLang("MATR480","STR0050",50)
#DEFINE STR0051 FWI18NLang("MATR480","STR0051",51)
#DEFINE STR0052 FWI18NLang("MATR480","STR0052",52)
#DEFINE STR0053 FWI18NLang("MATR480","STR0053",53)
#DEFINE STR0054 FWI18NLang("MATR480","STR0054",54)
#DEFINE STR0055 FWI18NLang("MATR480","STR0055",55)
#DEFINE STR0056 FWI18NLang("MATR480","STR0056",56)
#DEFINE STR0057 FWI18NLang("MATR480","STR0057",57)
#DEFINE STR0058 FWI18NLang("MATR480","STR0058",58)
#DEFINE STR0059 FWI18NLang("MATR480","STR0059",59)
#DEFINE STR0060 FWI18NLang("MATR480","STR0060",60)
#DEFINE STR0061 FWI18NLang("MATR480","STR0061",61)
#DEFINE STR0062 FWI18NLang("MATR480","STR0062",62)
#DEFINE STR0063 FWI18NLang("MATR480","STR0063",63)
#DEFINE STR0064 FWI18NLang("MATR480","STR0064",64)
#DEFINE STR0065 FWI18NLang("MATR480","STR0065",65)
#DEFINE STR0066 FWI18NLang("MATR480","STR0066",66)
#DEFINE STR0067 FWI18NLang("MATR480","STR0067",67)
#DEFINE STR0068 FWI18NLang("MATR480","STR0068",68)
#DEFINE STR0069 FWI18NLang("MATR480","STR0069",69)

/*
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Funcao	� MGF34R14  � Autor �Geronimo Benedito Alves�Data � 01.02.18 ���
�������������������������������������������������������������������������Ĵ��
���Descricao �Relatorio de Controle de Materiais de Terceiros em nosso po-���
���			�der e nosso Material em poder de Terceiros.					���
���			�Baseado no relatorio MATR480								���
�������������������������������������������������������������������������Ĵ��
���Sintaxe e �															���
�������������������������������������������������������������������������Ĵ��
��� Uso		 � Customizado												���
�������������������������������������������������������������������������Ĵ��
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
*/
User Function MGF34R14()
	Local oReport
	Private _cCODFILIA, _aSelFil		:= {}
	
	Pergunte("MTR480",.T.)				// Abre tela de pergunte para usuario informar os parametros do relatorio
	If (mv_par08 - mv_par07 > 180)
		MsgStop("O intervalo entre a data inicial e a data final � maior que o intervalo maximo permitido que � de 180 dias")
		Return Nil
	EndIf

	AdmSelecFil("", 0 ,.F.,@_aSelFil,"",.F.)		// Rotina que obtem a selec�o das FILIAIS a processar e as armazena na array _aSelFil  
	If Empty(_aSelFil) ; Return ; Endif
	_cCODFILIA	:= U_Array_In(_aSelFil)

	//������������������������������������������������������������������������Ŀ
	//�Interface de impressao													�
	//��������������������������������������������������������������������������
	oReport := ReportDef()
	oReport:PrintDialog()
Return


/*/
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Programa  �ReportDef � Autor �Nereu Humberto Junior  � Data �16.06.2006���
�������������������������������������������������������������������������Ĵ��
���Descricao �A funcao estatica ReportDef devera ser criada para todos os ���
���			�relatorios que poderao ser agendados pelo usuario.			���
���			�															���
�������������������������������������������������������������������������Ĵ��
���Retorno	�ExpO1: Objeto do relatorio									 ���
�������������������������������������������������������������������������Ĵ��
���Parametros�Nenhum														���
���			�															���
�������������������������������������������������������������������������Ĵ��
���	DATA	� Programador	�Manutencao efetuada							���
�������������������������������������������������������������������������Ĵ��
���			�				�											���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
/*/
Static Function ReportDef(nReg)

	Local oReport 
	Local oSection1
	Local oSection2 
	Local oSection3

	Local aOrdem := {}
	Local cTamVal:= TamSX3('B6_CUSTO1' )[1]
	Local cTamQtd:= TamSX3('B6_QUANT' )[1]

	Public mv_par01, mv_par02, mv_par03,mv_par04,mv_par05, mv_par06, mv_par12, mv_par13, mv_par14,  mv_par16 
	//mv_par09	:= mv_par09	// Esta linha, � apenas p/ na compilacao nao aparecer a msg "Local variable mv_par09 never used", que � indevida
	//mv_par11	:= mv_par11	// Esta linha, � apenas p/ na compilacao nao aparecer a msg "Local variable mv_par11 never used", que � indevida

	//������������������������������������������������������������������������Ŀ
	//�Criacao do componente de impressao										�
	//�																		�
	//�TReport():New															�
	//�ExpC1 : Nome do relatorio												�
	//�ExpC2 : Titulo														  �
	//�ExpC3 : Pergunte														�
	//�ExpB4 : Bloco de codigo que sera executado na confirmacao da impressao  �
	//�ExpC5 : Descricao														�
	//�																		�
	//��������������������������������������������������������������������������
	oReport:= TReport():New("MGF34R14","Relacao de materiais de Terceiros e em Terceiros (Cutomizado)","MTR480", {|oReport| ReportPrin(oReport)},STR0001+" "+STR0002+" "+"poder de Terceiros.  ( (Relatorio Customizado) )")
	oReport:SetLandscape()	
	oReport:SetTotalInLine(.F.)

	Pergunte("MTR480",.F.)

	Aadd( aOrdem, STR0004 ) //" Produto/Local " 
	Aadd( aOrdem, STR0005 ) //" Cliente/Fornecedor " 
	Aadd( aOrdem, STR0006 ) //" Dt. Mov/Produto " 

	oSection1 := TRSection():New(oReport,"Materiais de Terceiros e em Terceiros (Customizado)",{"SB6"},aOrdem) //"Relacao de materiais de Terceiros e em Terceiros"		// STR0052
	oSection1 :SetTotalInLine(.F.)

	TRCell():New(oSection1,"B1_COD"		,"SB1"	,/*Titulo*/	,/*Picture*/,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/)
	TRCell():New(oSection1,"B1_DESC"	,"SB1"	,/*Titulo*/	,/*Picture*/,30				,/*lPixel*/,/*{|| code-block de impressao }*/)
	TRCell():New(oSection1,"B6_LOCAL"	,"SB6"	,/*Titulo*/	,/*Picture*/,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/)
	TRCell():New(oSection1,"cCliFor"	,"	"	,/*Titulo*/	,/*Picture*/,6				,/*lPixel*/,/*{|| code-block de impressao }*/)
	///TRCell():New(oSection1,"cLoja"		,"	"	,/*Titulo*/	,/*Picture*/,2				,/*lPixel*/,/*{|| code-block de impressao }*/)
	TRCell():New(oSection1,"cNome"		,"	"	,/*Titulo*/	,/*Picture*/,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/)
	oSection1:Cell("cNome"):GetFieldInfo("A2_NOME")
	TRCell():New(oSection1,"B6_EMISSAO"	,"SB6"	,STR0038	,/*Picture*/,/*Tamanho*/	,/*lPixel*/,{|| (cAliasSB6)->B6_EMISSAO }) //"DATA DE MOVIMENTACAO : "

	oSection2 := TRSection():New(oSection1,STR0053,{"SB6"}) //"Relacao de materiais de Terceiros e em Terceiros"
	oSection2 :SetTotalInLine(.F.)	
	oSection2 :SetHeaderPage()

	//TRCell():New(oSection2,"B6_PRODUTO"	,"SB6",/*Titulo*/			,/*Picture*/				,15			,/*lPixel*/,{|| (cAliasSB6)->B6_PRODUTO })
	//TRCell():New(oSection2,"B6_TPCF"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| IIf((cAliasSB6)->B6_TPCF == "C",STR0018,STR0019) })
	//TRCell():NewrRr(oSection2,"B6_LOJA"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| (cAliasSB6)->B6_LOJA })
	TRCell():New(oSection2,"M0_FILIAL"	,"SM0","Nome"+CRLF+"Filial"	,/*Picture*/				,20			,/*lPixel*/,{|| (cAliasSB6)->M0_FILIAL })
	TRCell():New(oSection2,"B6_SERIE"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| (cAliasSB6)->B6_SERIE })
	TRCell():New(oSection2,"B6_DOC"		,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| (cAliasSB6)->B6_DOC },,,,,,.F.)
	TRCell():New(oSection2,"B6_EMISSAO"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| (cAliasSB6)->B6_EMISSAO })
	TRCell():New(oSection2,"B6_CLIFOR"	,"SB6",/*Titulo*/			,/*Picture*/				,TamSX3('B6_CLIFOR' )[1]+5,/*lPixel*/,{|| (cAliasSB6)->B6_CLIFOR })
	TRCell():New(oSection2,"cNmCliFor"	,"	","Nome"+CRLF+"CliFor"	,/*Picture*/				,30			,/*lPixel*/,{|| NomeClifor((cAliasSB6)->B6_TPCF, (cAliasSB6)->B6_CLIFOR, (cAliasSB6)->B6_LOJA)}) //"Nome Cliente/Fornecedor"
	TRCell():New(oSection2,"B6_UM"		,"SB6",STR0061				,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| If(mv_par15==1,(cAliasSB6)->B6_SEGUM,(cAliasSB6)->B6_UM) })
	TRCell():New(oSection2,"X5_DESCRI"	,"SX5","Descr."+CRLF+STR0061,/*Picture*/				,20			,/*lPixel*/,{|| (cAliasSB6)->X5_DESCRI  }) //"Descricao Unidade"
	TRCell():New(oSection2,"B6_QUANT"	,"SB6",STR0042+CRLF+STR0043	,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| If(mv_par15==1,ConvUM((cAliasSB6)->B6_PRODUTO,(cAliasSB6)->B6_QUANT,0,2),(cAliasSB6)->B6_QUANT) }) //"Quantidade"##"Original"
	TRCell():New(oSection2,"nQuJe"		,"	",STR0042+CRLF+STR0044	,PesqPict("SB6","B6_QUANT")	,cTamQtd	,/*lPixel*/,/*{|| code-block de impressao }*/) //"Quantidade"##"Ja entregue"				
	TRCell():New(oSection2,"nSaldo"		,"	","|"+space(cTamQtd-len(STR0045)-2)+STR0045+CRLF+"|"+space(ctamqtd)									, PesqPict("SB6", "B6_QUANT"),cTamQtd	,/*lPixel*/,/*{|| code-block de impressao }*/) //"Saldo"
	TRCell():New(oSection2,"nTotNF"		,"	","|"+space(cTamVal-len(STR0046)-2)+STR0046+CRLF+"|"+space(cTamVal-len(STR0047)-2)+STR0047			, '@E 99,999,999,999.99'		,cTamVal	,/*lPixel*/,/*{|| code-block de impressao }*/) //"Total"##"N.Fiscal"
	TRCell():New(oSection2,"nTotDev"	,"	","|"+space(cTamVal-len(STR0046)-2)+STR0046+CRLF+"|"+space(cTamVal-len(STR0048)-2)+STR0048			, '@E 99,999,999,999.99'		,cTamVal	,/*lPixel*/,/*{|| code-block de impressao }*/) //"Total"##"Devolvido"
	//TRCell():New(oSection2,"nCusto"		,"	","|"+space(cTamVal-len(STR0049)-2)+STR0049+"  |"+CRLF+"|"+space(cTamVal-len(STR0050)-2)+STR0050+"  |"	,'@E 999,999,999.99'		,cTamVal	,/*lPixel*/,/*{|| code-block de impressao }*/) //"Custo"##"Prod."
	//TRCell():New(oSection2,"B6_TIPO"	,"SB6",STR0051				,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| IIF((cAliasSB6)->B6_TIPO=="D","D","E") }) //"TM"
	//TRCell():New(oSection2,"B6_SEGUM"	,"SB6",STR0062				,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| (cAliasSB6)->B6_SEGUM })
	//TRCell():New(oSection2,"B6_QTSEGUM"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| (cAliasSB6)->B6_QTSEGUM })
	//TRCell():New(oSection2,"B6_DTDIGIT"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| (cAliasSB6)->B6_DTDIGIT })				
	//TRCell():New(oSection2,"B6_UENT"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/,/*lPixel*/,{|| (cAliasSB6)->B6_UENT })

	TRFunction():New(oSection2:Cell("B6_QUANT")	,NIL,"SUM",/*oBreak*/,/*Titulo*/,/*cPicture*/				,/*uFormula*/,.T.,.T.,,oSection1) 
	TRFunction():New(oSection2:Cell("nQuJe")	,NIL,"SUM",/*oBreak*/,/*Titulo*/,PesqPict("SB6","B6_QUANT")	,/*uFormula*/,.T.,.T.,,oSection1)
	TRFunction():New(oSection2:Cell("nSaldo")	,NIL,"SUM",/*oBreak*/,/*Titulo*/,PesqPict("SB6","B6_QUANT")	,/*uFormula*/,.T.,.T.,,oSection1)
	TRFunction():New(oSection2:Cell("nTotNF")	,NIL,"SUM",/*oBreak*/,/*Titulo*/,'@E 99,999,999,999.99'		,/*uFormula*/,.T.,.T.,,oSection1)
	TRFunction():New(oSection2:Cell("nTotDev")	,NIL,"SUM",/*oBreak*/,/*Titulo*/,'@E 99,999,999,999.99'		,/*uFormula*/,.T.,.T.,,oSection1)
	//TRFunction():New(oSection2:Cell("nCusto")	,NIL,"SUM",/*oBreak*/,/*Titulo*/,'@E 999,999,999.99'		,/*uFormula*/,.T.,.T.,,oSection1)

	oSection3 := TRSection():New(oSection2,STR0054,{"SB6"}) //"Relacao de materiais de Terceiros e em Terceiros"
	oSection3 :SetTotalInLine(.F.)

	//TRCell():New(oSection3,"B6_PRODUTO"	,"SB6",/*Titulo*/			,/*Picture*/					,15				,/*lPixel*/,{|| (cAliasSB6)->B6_PRODUTO })
	//TRCell():New(oSection3,"B6_TPCF"	,"SB6",/*Titulo*/			,/*Picture*/					,/*Tamanho*/	,/*lPixel*/,{|| IIf((cAliasSB6)->B6_TPCF == "C",STR0018,STR0019) })
	//TRCell():New(oSection3,"B6_LOJA"	,"SB6",/*Titulo*/			,/*Picture*/					,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/)
	TRCell():New(oSection3,"M0_FILIAL"	,"SM0","Nome"+CRLF+"Filial"	,/*Picture*/				,20				,/*lPixel*/,{|| (cAliasSB6)->M0_FILIAL })
	TRCell():New(oSection3,"B6_SERIE"	,"SB6",SerieNfId("SB6",7,"B6_SERIE"),/*Picture*/,SerieNfId("SB6",6,"B6_SERIE"),/*lPixel*/,/*{|| code-block de impressao }*/)
	TRCell():New(oSection3,"B6_DOC"		,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/,,,,,,.F.)
	TRCell():New(oSection3,"B6_EMISSAO" ,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/)
	TRCell():New(oSection3,"B6_CLIFOR"	,"SB6",/*Titulo*/			,/*Picture*/				,15				,/*lPixel*/,/*{|| code-block de impressao }*/)
	TRCell():New(oSection3,"cNmCliFor"	,"	","Nome"+CRLF+"CliFor"	,/*Picture*/				,30				,/*lPixel*/,{|| NomeClifor((cAliasSB6)->B6_TPCF, (cAliasSB6)->B6_CLIFOR, (cAliasSB6)->B6_LOJA)}) //"Nome Cliente/Fornecedor"
	TRCell():New(oSection3,"B6_UM"		,"SB6",STR0061				,/*Picture*/				,/*Tamanho*/	,/*lPixel*/,{|| If(mv_par15==1,(cAliasSB6)->B6_SEGUM,(cAliasSB6)->B6_UM) })
	TRCell():New(oSection3,"X5_DESCRI"	,"SX5","Descr."+CRLF+STR0061,/*Picture*/				,20				,/*lPixel*/,{|| (cAliasSB6)->X5_DESCRI  }) //"Descricao Unidade"
	TRCell():New(oSection3,"B6_QUANT"	,"SB6",STR0042+CRLF+STR0043	,/*Picture*/				,/*Tamanho*/	,/*lPixel*/,{|| If(mv_par15==1,ConvUM((cAliasSB6)->B6_PRODUTO,(cAliasSB6)->B6_QUANT,0,2),(cAliasSB6)->B6_QUANT) }) //"Quantidade"##"Original"
	TRCell():New(oSection3,"nQuJe"		,"	",STR0042+CRLF+STR0044	,PesqPict("SB6","B6_QUANT")	,cTamQtd		,/*lPixel*/,/*{|| code-block de impressao }*/) //"Quantidade"##"Ja entregue"				
	TRCell():New(oSection3,"nSaldo"		,"	","|"+space(cTamQtd-len(STR0045)-2)+STR0045+CRLF+"|"+space(ctamqtd)									,PesqPict("SB6", "B6_QUANT")	,cTamQtd		,/*lPixel*/,/*{|| code-block de impressao }*/) //"Saldo"
	TRCell():New(oSection3,"nTotNF"		,"	","|"+space(cTamVal-len(STR0046)-2)+STR0046+CRLF+"|"+space(cTamVal-len(STR0047)-2)+STR0047			,'@E 99,999,999,999.99'			,cTamVal		,/*lPixel*/,/*{|| code-block de impressao }*/) //"Total"##"N.Fiscal"
	TRCell():New(oSection3,"nTotDev"	,"	","|"+space(cTamVal-len(STR0046)-2)+STR0046+CRLF+"|"+space(cTamVal-len(STR0048)-2)+STR0048			,'@E 99,999,999,999.99'			,cTamVal		,/*lPixel*/,/*{|| code-block de impressao }*/) //"Total"##"Devolvido"
	//TRCell():New(oSection3,"nCusto"		,"	","|"+space(cTamVal-len(STR0049)-2)+STR0049+"  |"+CRLF+"|"+space(cTamVal-len(STR0050)-2)+STR0050+"  |"	,'@E 999,999,999.99'			,cTamVal		,/*lPixel*/,/*{|| code-block de impressao }*/) //"Custo"##"Prod."
	//TRCell():New(oSection3,"B6_TIPO"	,"SB6",STR0051				,/*Picture*/				,/*Tamanho*/	,/*lPixel*/,{|| IIF((cAliasSB6)->B6_TIPO=="D","D","E") }) //"TM"
	//TRCell():New(oSection3,"B6_SEGUM"	,"SB6",STR0062				,/*Picture*/				,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/)
	//TRCell():New(oSection3,"B6_QTSEGUM"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/)
	//TRCell():New(oSection3,"B6_DTDIGIT"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/)				
	//TRCell():New(oSection3,"B6_UENT"	,"SB6",/*Titulo*/			,/*Picture*/				,/*Tamanho*/	,/*lPixel*/,/*{|| code-block de impressao }*/)


Return(oReport)

/*/
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Programa  �ReportPrin� Autor �Nereu Humberto Junior  � Data �16.05.2006���
�������������������������������������������������������������������������Ĵ��
���Descricao �A funcao estatica ReportDef devera ser criada para todos os ���
���			�relatorios que poderao ser agendados pelo usuario.			���
���			�															���
�������������������������������������������������������������������������Ĵ��
���Retorno	�Nenhum														���
�������������������������������������������������������������������������Ĵ��
���Parametros�ExpO1: Objeto Report do Relatorio							���
���			�															���
�������������������������������������������������������������������������Ĵ��
���	DATA	� Programador	�Manutencao efetuada							���
�������������������������������������������������������������������������Ĵ��
���			�				�											���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
/*/
Static Function ReportPrin(oReport)

	Local oSection1 := oReport:Section(1) 
	Local oSection2 := oReport:Section(1):Section(1)  
	Local oSection3 := oReport:Section(1):Section(1):Section(1)  
	Local nOrdem	:= oReport:GetOrder() 
	Local lListCustM:= .T.
	Local lCusFIFO  := GetMV('MV_CUSFIFO')
	Local cProdLOCAL:= ""
	Local cCliForAnt:= ""
	Local cFilUser := oSection1:GetAdvplExp()
	Local lImprime  := .F.
	Local lFirstRec := .T.
	Local lPlanilha := oReport:nDevice == 4
	Local lPlanTab  := oReport:lXlsTable == .T.
	Local lFound	:= .F.
	Local nX		:= 0
	Local aStrucSB6 := {}

	Private cAliasSB6 := "SB6"
	
	lListCustM := (mv_par16==1)

	dbSelectArea("SB6")
	dbSetOrder(nOrdem)

	If nOrdem == 1
		oSection1 :SetTotalText(STR0020) //"TOTAL DESTE PRODUTO / LOCAL ------ >"
		If mv_par10 == 1
			oReport:SetTitle("(Customizado)	" + STR0010) //"RELACAO DE MATERIAIS DE TERCEIROS EM NOSSO PODER - PRODUTO / LOCAL"
		ElseIf mv_par10 == 2
			oReport:SetTitle("(Customizado)	" + STR0011) //"RELACAO DE MATERIAIS NOSSOS EM PODER DE TERCEIROS - PRODUTO / LOCAL"
		Else
			oReport:SetTitle("(Customizado)	" + STR0012) //"RELACAO DE MATERIAIS DE T` TERCEIROS - PRODUTO / LOCAL"
		EndIf
	ElseIf nOrdem == 2
		oSection1 :SetTotalText(STR0032) //"TOTAL DO PRODUTO NO "
		If mv_par10 == 1
			oReport:SetTitle("(Customizado)	" + STR0023) //"RELACAO DE MATERIAIS DE TERCEIROS EM NOSSO PODER - CLIENTE / FORNECEDOR"
		ElseIf mv_par10 == 2
			oReport:SetTitle("(Customizado)	" + STR0024) //"RELACAO DE MATERIAIS NOSSOS EM PODER DE TERCEIROS - CLIENTE / FORNECEDOR"
		Else
			oReport:SetTitle("(Customizado)	" + STR0025) //"RELACAO DE MATERIAIS DE TERCEIROS E EM TERCEIROS - CLIENTE / FORNECEDOR"
		EndIf
	ElseIf nOrdem == 3
		oSection2:Cell("B6_DOC"):SetSize(12)
		oSection3:Cell("B6_DOC"):SetSize(12)
		oSection2:Cell("B6_DOC"):SetLineBreak() 
		oSection3:Cell("B6_DOC"):SetLineBreak() 
		oSection1 :SetTotalText(STR0040) //"TOTAL DO PRODUTO NA DATA --------- >"
		If mv_par10 == 1
			oReport:SetTitle("(Customizado)	" + STR0033) //"RELACAO DE MATERIAIS DE TERCEIROS EM NOSSO PODER - DATA DO MOVIMENTO"
		ElseIf mv_par10 == 2
			oReport:SetTitle("(Customizado)	" + STR0034) //"RELACAO DE MATERIAIS NOSSOS EM PODER DE TERCEIROS - DATA DO MOVIMENTO"
		Else
			oReport:SetTitle("(Customizado)	" + STR0035) //"RELACAO DE MATERIAIS DE TERCEIROS E EM TERCEIROS - DATA DO MOVIMENTO"
		EndIf
	Endif
	//������������������������������������������������������������������������Ŀ
	//�Inicio da impressao do fluxo do relatorio								�
	//��������������������������������������������������������������������������
	oReport:SetMeter(SB6->(LastRec()))

	cAliasSB6 := GetNextAlias()
	aStrucSB6 := SB6->(dbStruct())		 
	cQuery	  := " SELECT SB6.*, SB6.R_E_C_N_O_, SF4.F4_PODER3, SM0.M0_CODIGO, SM0.M0_FILIAL, SX5.X5_DESCRI " 
	cQuery	  += " FROM " + RetSqlName("SB6") + " SB6" 
	cQuery	  += " JOIN " + RetSqlName("SF4") + " SF4" 
	cQuery	  += " ON SF4.F4_FILIAL = '"	+ xFilial("SF4") + "' " 
	cQuery	  += " AND SF4.F4_CODIGO = SB6.B6_TES AND SF4.F4_PODER3 <> 'D' " 
	cQuery	+= " AND SF4.D_E_L_E_T_ = ' ' "  
	cQuery	  += " INNER JOIN  " + U_IF_BIMFR("PROTHEUS", "SYS_COMPANY"  ) + " SM0"
	cQuery	+= " ON SM0.M0_CODFIL = SB6.B6_FILIAL"
	cQuery	+= " AND SM0.D_E_L_E_T_ = ' '"
	cQuery	+= " INNER JOIN " + RetSqlName("SX5") + " SX5"
	cQuery	+= " ON SX5.X5_FILIAL = '"	+ xFilial("SX5") + "' "
	cQuery	+= " AND SX5.X5_TABELA = '62'"
	cQuery	+= " AND SX5.X5_CHAVE = SB6.B6_UM"
	cQuery	+= " AND SX5.D_E_L_E_T_ = ' '"
	cQuery	+= " WHERE SB6.B6_FILIAL IN " + _cCODFILIA 
	cQuery	+= " AND ((SB6.B6_TPCF = 'C' AND B6_CLIFOR >= '" + mv_par01 + "' AND B6_CLIFOR <= '" + mv_par02 + "' ) " 
	cQuery	+= " OR  ( SB6.B6_TPCF = 'F' AND B6_CLIFOR >= '" + mv_par03 + "' AND B6_CLIFOR <= '" + mv_par04 + "' ))" 
	cQuery	+= " AND SB6.B6_PRODUTO >= '" + mv_par05 + "' " 
	cQuery	+= " AND SB6.B6_PRODUTO <= '" + mv_par06 + "' " 
	cQuery	+= " AND SB6.B6_DTDIGIT >= '"+ DTOS(mv_par07) +"' AND SB6.B6_DTDIGIT <= '" + DTOS(mv_par08) + "' " 
	If mv_par10 == 1
		cQuery  += " AND SB6.B6_TIPO = 'D' "
	ElseIf mv_par10 == 2
		cQuery  += " AND SB6.B6_TIPO = 'E' "
	EndIf
	cQuery	+= " AND SB6.B6_QUANT <> 0 AND SB6.D_E_L_E_T_ = ' ' "

	If nOrdem == 1
		cQuery += " ORDER BY B6_FILIAL, B6_PRODUTO, B6_LOCAL "
	ElseIf nOrdem == 2
		cQuery += " ORDER BY B6_FILIAL,B6_TPCF,B6_CLIFOR,B6_LOJA,B6_PRODUTO "
	Else	
		cQuery += " ORDER BY B6_FILIAL,B6_DTDIGIT,B6_PRODUTO,B6_CLIFOR,B6_LOJA"
	EndIf

	cQuery := ChangeQuery(cQuery)
	MemoWrite( GetTempPath(.T.) + "AAA_" + FunName() +".TXT",cQuery)

	MsAguarde({|| dbUseArea(.T.,"TOPCONN",TCGenQry(,,cQuery),cAliasSB6,.F.,.T.)},STR0069) //"Processando ..."

	dbSelectArea(cAliasSB6)
	For nX := 1 To Len(aStrucSB6)
		If ( aStrucSB6[nX][2] <> "C" .And. FieldPos(aStrucSB6[nX][1])<>0 )
			TcSetField(cAliasSB6,aStrucSB6[nX][1],aStrucSB6[nX][2],aStrucSB6[nX][3],aStrucSB6[nX][4])
		EndIf
	Next

	Do Case
		Case nOrdem == 1
		IF lPlanTab
			oSection1:Cell("cCliFor"):Hide()
			///			oSection1:Cell("cLoja"):Hide()
			oSection1:Cell("cNome"):Hide()
			oSection1:Cell("B6_EMISSAO"):Hide()
			///			oSection2:Cell("B6_PRODUTO"):Hide()
			///			oSection3:Cell("B6_PRODUTO"):Hide()
		Else 
			oSection1:Cell("cCliFor"):Disable()
			///			oSection1:Cell("cLoja"):Disable()
			oSection1:Cell("cNome"):Disable()
			oSection1:Cell("B6_EMISSAO"):Disable()
			///			oSection2:Cell("B6_PRODUTO"):Disable()
			///			oSection3:Cell("B6_PRODUTO"):Disable()
		EndIF

		Case nOrdem == 2
		If !lPlanilha
			oSection1:Cell("B1_COD" ):Disable()
			oSection1:Cell("B1_DESC"):Disable()
			oSection1:Cell("B6_LOCAL"  ):Disable()
			oSection1:Cell("B6_EMISSAO"):Disable()
		EndIf

		///		oSection2:Cell("B6_TPCF"	):Disable()
		oSection2:Cell("B6_CLIFOR" ):Disable()
		///		oSection2:Cell("B6_LOJA"	):Disable()			

		///		oSection3:Cell("B6_TPCF"	):Disable()
		oSection3:Cell("B6_CLIFOR" ):Disable()
		///		oSection3:Cell("B6_LOJA"	):Disable()

		Case nOrdem == 3
		If !lPlanilha
			oSection1:Cell("B1_COD" ):Disable()
			oSection1:Cell("B1_DESC"):Disable()
		EndIf
		IF lPlanTab
			oSection1:Cell("B6_LOCAL"):Hide()
			oSection1:Cell("cCliFor"):Hide()
			///			oSection1:Cell("cLoja"):Hide()
			oSection1:Cell("cNome"):Hide()
		Else
			oSection1:Cell("B6_LOCAL"):Disable()
			oSection1:Cell("cCliFor"):Disable()
			///		 	oSection1:Cell("cLoja"):Disable()
			oSection1:Cell("cNome"):Disable()
		EndIf
	EndCase

	While !oReport:Cancel() .And. !(cAliasSB6)->(Eof()) 
		
		If oReport:Cancel()
			Exit
		EndIf

		oReport:IncMeter()

		If !Empty(cFilUser)
			SB6->(dbSetOrder(1))
			SB6->(dbSeek( (cAliasSB6)->B6_FILIAL + (cAliasSB6)->B6_PRODUTO+(cAliasSB6)->B6_CLIFOR+(cAliasSB6)->B6_LOJA+(cAliasSB6)->B6_IDENT))
			If !(&(cFilUser))
				(cAliasSB6)->(dbSkip())
				Loop
			EndIf	
		EndIf

		aSaldo	:= (cAliasSB6)->(CalcTerc(B6_PRODUTO,B6_CLIFOR,B6_LOJA,B6_IDENT,B6_TES,,mv_par07,mv_par08, (cAliasSB6)->B6_FILIAL))
		nSaldo  := aSaldo[1]
		nPrUnit := IIF(aSaldo[3]==0,(cAliasSB6)->(B6_PRUNIT),aSaldo[3])

		If mv_par09 == 2 .And. nSaldo <= 0
			(cAliasSB6)->(dbSkip())
			Loop
		EndIf

		If nOrdem == 1
			cQuebra := (cAliasSB6)->(B6_PRODUTO+B6_LOCAL)
		ElseIf nOrdem == 2
			cQuebra := (cAliasSB6)->(B6_CLIFOR+B6_LOJA+B6_PRODUTO+B6_TPCF)
		ElseIf nOrdem == 3
			cQuebra := (cAliasSB6)->(Dtos(B6_EMISSAO)+B6_PRODUTO)
			lImprime := .T.
		Endif

		While !oReport:Cancel() .And. !(cAliasSB6)->(Eof()) ; 	//  .And. cFilAnt == (cAliasSB6)->B6_FILIAL ;	// Ajustei. Troquei xFilial("SB6") por cFilAnt.  A pric�pio comentei parte desta linha j� que agora o processamento � multi-filial, a posterior,notei nao ser necessario
		.And. Iif(nOrdem==1,cQuebra == (cAliasSB6)->(B6_PRODUTO+B6_LOCAL),If(nOrdem==2,cQuebra == (cAliasSB6)->(B6_CLIFOR+B6_LOJA+B6_PRODUTO+B6_TPCF),cQuebra == (cAliasSB6)->(Dtos(B6_EMISSAO)+B6_PRODUTO)))

			If oReport:Cancel()
				Exit
			EndIf

			oReport:IncMeter()

			aSaldo	:= (cAliasSB6)->(CalcTerc(B6_PRODUTO,B6_CLIFOR,B6_LOJA,B6_IDENT,B6_TES,,mv_par07,mv_par08, (cAliasSB6)->B6_FILIAL ))
			nSaldo  := aSaldo[1]
			nPrUnit := IIF(aSaldo[3]==0,(cAliasSB6)->(B6_PRUNIT),aSaldo[3])

			If mv_par09 == 2 .And. nSaldo <= 0
				(cAliasSB6)->(dbSkip())
				Loop
			EndIf

			SB6->(MsGoto((cAliasSB6)->R_E_C_N_O_ ))

			oSection1:Init()
			If nOrdem == 1
				If cProdLOCAL != (cAliasSB6)->(B6_PRODUTO+B6_LOCAL)
					If SB1->(dbSeek(xFilial("SB1")+(cAliasSB6)->B6_PRODUTO))
						oSection1:PrintLine()			
						cProdLOCAL := (cAliasSB6)->(B6_PRODUTO+B6_LOCAL)
					Else
						Help(" ",1,"R480PRODUT")
						dbSelectArea("SB6")
						Return .F.
					EndIf
				EndIf
				If !Empty(cProdLOCAL)
					oSection2:Init()

					oSection2:Cell("nQuJe"):SetValue(If(mv_par15==1,ConvUM((cAliasSB6)->B6_PRODUTO,((cAliasSB6)->B6_QUANT - nSaldo),0,2),((cAliasSB6)->B6_QUANT - nSaldo)))
					oSection2:Cell("nSaldo"):SetValue(If(mv_par15==1,ConvUm((cAliasSB6)->B6_PRODUTO,nSaldo,0,2),nSaldo))
					oSection2:Cell("nTotNF"):SetValue(round(aSaldo[5],2))
					oSection2:Cell("nTotDev"):SetValue(( (cAliasSB6)->B6_QUANT - nSaldo) * nPrUnit)
					///				oSection2:Cell("B6_TIPO"):SetValue(B6_TIPO)
					// Custo na Moeda
					nCusto := (&(If(lListCustM.Or.(!lListCustM.And.!lCusFIFO), 'SB6->B6_CUSTO', 'SB6->B6_CUSFF')+Str(mv_par11,1,0)) / (cAliasSB6)->(B6_QUANT)) * nSaldo
					///				oSection2:Cell("nCusto"):SetValue(nCusto)

					oSection2:PrintLine()
				Endif	
			ElseIf nOrdem == 2
				If cCliForAnt != (cAliasSB6)->(B6_TPCF) .Or. cNomeCliFor != (cAliasSB6)->(B6_CLIFOR+B6_LOJA)

					If lPlanilha .And. !lFirstRec
						oSection1:Cell("cCliFor"):Enable()
						///					oSection1:Cell("cLoja"):Enable()
						oSection1:Cell("cNome"):Enable()
						oSection1:Cell("B6_EMISSAO"):Enable()
					EndIf

					lFirstRec := .T.
					If (cAliasSB6)->(B6_TPCF) == "C" 
						SA1->(MsSeek(xFilial("SA1")+(cAliasSB6)->(B6_CLIFOR+B6_LOJA)))
						oSection1 :SetTotalText(STR0032+STR0030) //"TOTAL DO PRODUTO NO "##"CLIENTE ---->"###"FORNECEDOR --->"
					Else
						SA2->(MsSeek(xFilial("SA2")+(cAliasSB6)->(B6_CLIFOR+B6_LOJA)))
						oSection1 :SetTotalText(STR0032+STR0031) //"TOTAL DO PRODUTO NO "##"FORNECEDOR --->"
					Endif	

					lFound := IIf((cAliasSB6)->(B6_TPCF) == "C", SA1->(!Eof()),SA2->(!Eof()) )

					If lFound
						dbSelectArea("SB6")

						oSection1:Cell("cCliFor"):SetTitle(IIf((cAliasSB6)->(B6_TPCF) == "C",STR0028,STR0029)) //"CLIENTE / LOJA: "###"FORNECEDOR / LOJA: "
						oSection1:Cell("cCliFor"):SetValue(Iif((cAliasSB6)->(B6_TPCF) == "C",SA1->A1_COD,SA2->A2_COD))

						///					oSection1:Cell("cLoja"):SetValue(Iif((cAliasSB6)->(B6_TPCF) == "C",SA1->A1_LOJA,SA2->A2_LOJA))
						oSection1:Cell("cNome"):SetValue(Iif((cAliasSB6)->(B6_TPCF) == "C",SA1->A1_NOME,SA2->A2_NOME))

						If lPlanilha .And. lFirstRec
							SB1->(DbSetOrder(1))
							SB1->(MsSeek(xFilial("SB1")+(cAliasSB6)->(B6_PRODUTO)))
							oSection1:Cell("B1_COD"):SetValue(SB1->B1_COD)
							oSection1:Cell("B1_DESC"):SetValue(SB1->B1_DESC)
						EndIf

						oSection1:PrintLine()			

						cNomeCliFor := (cAliasSB6)->(B6_CLIFOR+B6_LOJA)
						cCliForAnt  := (cAliasSB6)->(B6_TPCF)
					Else
						Help(" ",1,"R480CLIFOR")
						Return .F.
					EndIf
				EndIf
				If Len(cNomeCliFor) != 0
					oSection2:Init()

					oSection2:Cell("nQuJe"):SetValue(If(mv_par15==1,ConvUM((cAliasSB6)->(B6_PRODUTO),((cAliasSB6)->(B6_QUANT) - nSaldo),0,2),((cAliasSB6)->(B6_QUANT) - nSaldo)))
					oSection2:Cell("nSaldo"):SetValue(If(mv_par15==1,ConvUm((cAliasSB6)->(B6_PRODUTO),nSaldo,0,2),nSaldo))
					oSection2:Cell("nTotNF"):SetValue(round(aSaldo[5],2))
					oSection2:Cell("nTotDev"):SetValue(((cAliasSB6)->(B6_QUANT) - nSaldo) * nPrUnit)
					// Custo na Moeda
					nCusto := (&(If(lListCustM.Or.(!lListCustM.And.!lCusFIFO), 'SB6->B6_CUSTO', 'SB6->B6_CUSFF')+Str(mv_par11,1,0)) / (cAliasSB6)->B6_QUANT) * nSaldo
					///				oSection2:Cell("nCusto"):SetValue(nCusto)

					If lPlanilha .And. !lFirstRec
						SB1->(DbSetOrder(1))
						SB1->(MsSeek(xFilial("SB1")+(cAliasSB6)->(B6_PRODUTO)))
						oSection1:Cell("B1_COD"):SetValue(SB1->B1_COD)
						oSection1:Cell("B1_DESC"):SetValue(SB1->B1_DESC)
						If lPlanTab
							oSection1:Cell("B6_LOCAL"):Hide()
							oSection1:Cell("cCliFor"):Hide()
							///					oSection1:Cell("cLoja"):Hide()
							oSection1:Cell("cNome"):Hide()
							oSection1:Cell("B6_EMISSAO"):Hide()
							oSection1:PrintLine()
						Else 
							oSection1:Cell("B6_LOCAL"):Disable()
							oSection1:Cell("cCliFor"):Disable()
							///					oSection1:Cell("cLoja"):Disable()
							oSection1:Cell("cNome"):Disable()
							oSection1:Cell("B6_EMISSAO"):Disable()
						EndIf
					EndIf
					lFirstRec := .F.

					oSection2:PrintLine()
				Endif
			ElseIf nOrdem == 3
				If lImprime
					If lPlanilha
						SB1->(DbSetOrder(1))
						SB1->(MsSeek(xFilial("SB1")+(cAliasSB6)->(B6_PRODUTO)))
						oSection1:Cell("B1_COD"):SetValue(SB1->B1_COD)
						oSection1:Cell("B1_DESC"):SetValue(SB1->B1_DESC)
						oSection1:PrintLine()
					Else
						oSection1:PrintLine()
					EndIf				
					lImprime := .F.
				Endif	

				oSection2:Init()

				oSection2:Cell("nQuJe"):SetValue(If(mv_par15==1,ConvUM((cAliasSB6)->(B6_PRODUTO),((cAliasSB6)->(B6_QUANT) - nSaldo),0,2),((cAliasSB6)->(B6_QUANT) - nSaldo)))
				oSection2:Cell("nSaldo"):SetValue(If(mv_par15==1,ConvUm((cAliasSB6)->(B6_PRODUTO),nSaldo,0,2),nSaldo))
				oSection2:Cell("nTotNF"):SetValue(round(aSaldo[5],2))
				oSection2:Cell("nTotDev"):SetValue(((cAliasSB6)->B6_QUANT - nSaldo) * nPrUnit)		// Geronimo, verificar se o campo B6_QUANT � realmente da tabela (cAliasSB6), e nao da SB6 
				// Custo na Moeda
				nCusto := (&(If(lListCustM.Or.(!lListCustM.And.!lCusFIFO), 'B6_CUSTO', 'B6_CUSFF')+Str(mv_par11,1,0)) / (cAliasSB6)->(B6_QUANT)) * nSaldo
				///			oSection2:Cell("nCusto"):SetValue(nCusto)

				oSection2:PrintLine()				
			Endif	
			// Lista as devolucoes da remessa
			If mv_par12 == 1 .And. (((cAliasSB6)->(B6_QUANT) - nSaldo) > 0)
				aAreaSB6 := SB6->(GetArea())
				SB6->(dbSetOrder(3))
				cSeek:=(cAliasSB6)->B6_FILIAL+(cAliasSB6)->(B6_IDENT+B6_PRODUTO)+"D"
				If SB6->(dbSeek(cSeek))
					oReport:PrintText(STR0041) //"Notas Fiscais de Retorno"
					Do While !Eof() .And. SB6->B6_FILIAL+ SB6->B6_IDENT+ SB6->B6_PRODUTO+ SB6->B6_PODER3 == cSeek
						If SB6->B6_DTDIGIT < mv_par13 .Or. SB6->B6_DTDIGIT > mv_par14
							SB6->(dbSkip())
							Loop
						Endif
						oSection3:Init(.F.)
						If nOrdem == 2
							oSection3:Cell("B6_PRODUTO"):Hide()
						Endif	
						oSection3:Cell("B6_QUANT"):SetValue(SB6->B6_QUANT)
						oSection3:Cell("nQuJe"):Hide()
						oSection3:Cell("nSaldo"):Hide()
						oSection3:Cell("nTotDev"):Hide()
						///					oSection3:Cell("nCusto"):Hide()

						oSection3:Cell("nTotNF"):SetValue(SB6->B6_QUANT * nPrUnit)
						oSection3:PrintLine()
						SB6->(dbSkip())
					EndDo
					oSection3:Finish()
				EndIf
				RestArea(aAreaSB6)
			EndIf					
			dbSelectArea(cAliasSB6)  
			dbSkip()
		EndDo
		oSection2:Finish()
		oSection1:Finish()
	EndDo
 
Return NIL


/*/
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Programa  �NomeClifor� Autor � Geronimo Benedito Alves �Data �07/02/18 ���
�������������������������������������������������������������������������Ĵ��
���Descricao �Retorna o nome do cliente ou fornecedor						���
���			�relatorios que poderao ser agendados pelo usuario.			���
���			�															���
�������������������������������������������������������������������������Ĵ��
���Retorno	�Nenhum														���
�������������������������������������������������������������������������Ĵ��
���Parametros�ExpO1: Objeto Report do Relatorio							���
���			�															���
�������������������������������������������������������������������������Ĵ��
���	DATA	� Programador	�Manutencao efetuada							���
�������������������������������������������������������������������������Ĵ��
���			�				�											���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
/*/
Static Function NomeClifor( c_TPCF, cFornCli, cLoja)
	Local aArea := GetArea()
	lOCAL cRet := " "

	If  c_TPCF == "C"
		DbSelectArea("SA1")
		DbSetOrder(1)
		DbSeek(xFilial("SA1") + cFornCli + cLoja )
		cRet	:= SA1->A1_NOME

	Else
		DbSelectArea("SA2")
		DbSetOrder(1)
		DbSeek(xFilial("SA2") + cFornCli + cLoja )
		cRet	:= SA2->A2_NOME

	Endif

	RestArea(aArea)
Return cRet




/*/
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Funcao	� CalcTerc � Autor �Geronimo Benedito Alves� Data � 14.05.18 ���
�������������������������������������������������������������������������Ĵ��
���Descricao � Retorna um Array onde:										���
���			� aSaldo[1] := Saldo de Poder Terceiro						���
���			� aSaldo[2] := Quantidade Poder Terceiro Liberada(ainda nao  ���
���			�								faturada)					���
���			� aSaldo[3] := Saldo total do poder de terceiro ( Valor)		���
���			� aSaldo[4] := Soma do total de devolucoes do Poder Terceiros���			
���			� aSaldo[5] := Valor Total em Poder Terceiros				  ���
���			� aSaldo[6] := Quantidade Total em Poder Terceiros			  ���
�������������������������������������������������������������������������Ĵ��
���Sintaxe	� ExpA1(ExpC1,ExpC2,ExpC3,ExpC4,ExpC5,ExpC6)					���
�������������������������������������������������������������������������Ĵ��
���Parametros� ExpC1 = Codigo do Produto									 ���
���			� ExpC2 = Codigo do Cliente/Fornecedor						���
���			� ExpC3 = Codigo da Loja										���
���			� ExpC4 = Codigo do identIficador do SB6						���
���			� ExpC5 = Codigo da Tes										���
���			� ExpC6 = Tipo da Nota										���
���			 � ExpD1 = Dt Inicial a ser Considerada na Composi��o do Saldo���
���			 � ExpD2 = Dt Final a ser Considedara na Composi��o do Saldo  ���
�������������������������������������������������������������������������Ĵ��
��� Uso		 � Especifico para a Cliente									 ���
�������������������������������������������������������������������������Ĵ��
���Observacao� Criada a partir da func�o padrao CalcTerc() do Matxatu.prx ���
���			� Efetuado Ajustes para permitir processamentos Multifiliais,���
���			� Pois a versao padrao preve apenas o processamento filial	���
���			� Atual. Alterada as referencias no SB6 (arquivo exclusivo)  ���
���			� de xFilial() para a varialves _FiliaProc.					���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
/*/
Static Function CalcTerc(cCod,cClIfor,cLoja,cIdentB6,cTesB6,cTipo,dDtIni,dDtFim, _FiliaProc)

Local aArq		:= GetArea()
Local aArqSF4	:= SF4->(GetArea())
Local aArqSB6	:= SB6->(GetArea())
Local aStruSB6	:= {}
Local aSaldo		:= {0,0,0,0,0,0}
Local lConsIni	:= (ValType(dDtIni)=='D'.And.!Empty(dDtIni))
Local lConsFim	:= (ValType(dDtFim)=='D'.And.!Empty(dDtFim))
Local lQuery		:= .F.
Local cAliasSB6  := "SB6"
Local cAliasSF4  := "SF4"  
Local aNF		:= {}
Local cNF		:= ""
Local l103		:= IsInCallStack("MATA103")

Local cQuery		:= ""
Local nX			:= 0


dbSelectArea("SB6")
If !Empty(cIdentB6)
	DbSetOrder(3)

	lQuery		:= .T.
	aStruSB6	:= SB6->(dbStruct())
	cAliasSB6  := "CALCTERC"
	cAliasSF4  := "CALCTERC"			

	cQuery := "SELECT "+SqlOrder(SB6->(IndexKey()))+","
	For nX := 1 To Len(aStruSB6)
		If !aStruSB6[nX][1]$cQuery
			cQuery += aStruSB6[nX][1]+","
		EndIf
	Next nX
	cQuery += "SF4.F4_PODER3 "
	cQuery += " FROM "+RetSqlName("SB6")+" SB6,"+RetSqlName("SF4")+" SF4 "
	cQuery += "WHERE SB6.B6_FILIAL='" +_FiliaProc+ "' AND "
	cQuery += "SB6.B6_IDENT='"+cIdentB6+"' AND "
	cQuery += "SB6.B6_PRODUTO='"+cCod+"' AND "
	cQuery += "SB6.D_E_L_E_T_=' ' AND "
	If cTesB6 <= "500"
		If cTipo == "B"
			cQuery += "SB6.B6_TPCF='C' AND "
		ElseIf cTipo == "N"
			cQuery += "SB6.B6_TPCF='F' AND "
		EndIf
	Else
		If cTipo == "B"
			cQuery += "SB6.B6_TPCF='F' AND "
		ElseIf cTipo == "N"
			cQuery += "SB6.B6_TPCF='C' AND "
		EndIf
	EndIf
	If ( lConsIni )
		cQuery += "SB6.B6_DTDIGIT>='"+Dtos(dDtIni)+"' AND "
	EndIf
	If ( lConsFim )	
		cQuery += "SB6.B6_DTDIGIT<='"+Dtos(dDtFim)+"' AND "
	EndIf
	cQuery += "SF4.F4_FILIAL='"+xFilial("SF4")+"' AND "
	cQuery += "SF4.F4_CODIGO=SB6.B6_TES AND "
	cQuery += "SF4.D_E_L_E_T_=' ' "
	cQuery += "UNION ALL "+StrTran(cQuery,"B6_IDENT=","B6_IDENTB6=")+" "
	cQuery += "ORDER BY 1,2,3,4"
	
	cQuery := ChangeQuery(cQuery)
		
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSB6,.T.,.T.)
		
	For nX := 1 To Len(aStruSB6)
		If ( aStruSB6[nX][2] <> "C" )
			TcSetField(cAliasSB6,aStruSB6[nX][1],aStruSB6[nX][2],aStruSB6[nX][3],aStruSB6[nX][4])
		EndIf
	Next nX															
	
	While !Eof() .And. _FiliaProc == (cAliasSB6)->B6_FILIAL .And.;
		(cIdentB6==(cAliasSB6)->B6_IDENTB6 .Or.;
		cIdentB6==(cAliasSB6)->B6_IDENT ) .And.;
		cCod == (cAliasSB6)->B6_PRODUTO
		
		If  !lQuery
			If !Empty((cAliasSB6)->B6_IDENTB6)
				DbSelectArea(cAliasSB6)
				DbSkip()
				Loop
			EndIf
			DbSelectArea("SF4")
			dbSetOrder(1)
			DbSeek(xFilial()+(cAliasSB6)->B6_TES)
			//-- Condicao para DBFCDX deve ser o inverso do SQL, ja que indica registros a serem
			//-- desconsiderados, ao contrario do SQL que indica registros a serem considerados
			If cTesB6 <= "500"
				If (cTipo == "B" .And. (cAliasSB6)->B6_TPCF != "C") .Or. (cTipo == "N" .And. (cAliasSB6)->B6_TPCF != "F")
					DbSelectArea(cAliasSB6)
					DbSkip()
					Loop
				EndIf
			Else
				If (cTipo == "B" .And. (cAliasSB6)->B6_TPCF != "F") .Or. (cTipo == "N" .And. (cAliasSB6)->B6_TPCF != "C")
					DbSelectArea(cAliasSB6)
					DbSkip()
					Loop
				EndIf
			EndIf
			//-- Condicao para DBF deve ser o inverso do SQL, ja que indica registros a serem
			//-- desconsiderados, ao contrario do SQL que indica registros a serem considerados
			//-- Consiste Data Inicial e Final na Composi��o do Saldo
			If (lConsIni.And.(cAliasSB6)->B6_DTDIGIT<dDtIni).Or.(lConsFim.And.(cAliasSB6)->B6_DTDIGIT>dDtFim)
				DbSelectArea(cAliasSB6)
				DbSkip()
				Loop
			EndIf
		EndIf
		If (cAliasSF4)->F4_PODER3 == "R"
			aSaldo[1]+= (cAliasSB6)->B6_QUANT
			aSaldo[2]+= (cAliasSB6)->B6_QULIB
			
			If l103
				aSaldo[3]+= ((cAliasSB6)->B6_PRUNIT*(cAliasSB6)->B6_QUANT)-aSaldo[4] 
			Else
				aSaldo[3]+= ((cAliasSB6)->B6_PRUNIT*IIF((cAliasSB6)->B6_QUANT==0,1,aSaldo[1]))
			EndIf
			
			If (cAliasSB6)->B6_QUANT == 0 
				aSaldo[5]+= (cAliasSB6)->B6_PRUNIT
			Else
				aSaldo[5]+= (cAliasSB6)->B6_PRUNIT * (cAliasSB6)->B6_QUANT
				aSaldo[6]= (cAliasSB6)->B6_QUANT
			EndIf
		ElseIf (cAliasSF4)->F4_PODER3 == "D"
			aSaldo[1]-= (cAliasSB6)->B6_QUANT

			SD1->(dbSetOrder(1))
			SD1->(dbSeek( _FiliaProc +(cAliasSB6)->B6_DOC+(cAliasSB6)->B6_SERIE+(cAliasSB6)->B6_CLIFOR+(cAliasSB6)->B6_LOJA+(cAliasSB6)->B6_PRODUTO))
			While !Eof() .And. _FiliaProc == SD1->D1_FILIAL .And.;
				(cAliasSB6)->B6_DOC == SD1->D1_DOC .And.;
				(cAliasSB6)->B6_SERIE == SD1->D1_SERIE .And.;
				(cAliasSB6)->B6_CLIFOR == SD1->D1_FORNECE .And.;
				(cAliasSB6)->B6_LOJA == SD1->D1_LOJA .And.;
				(cAliasSB6)->B6_PRODUTO == SD1->D1_COD
				
				// Verifica se o Item j� nao esta somado para nao duplicar a soma //
				cNF:= SD1->D1_FILIAL+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_COD+SD1->D1_ITEM
				If (cAliasSB6)->B6_IDENT==SD1->D1_IDENTB6 
					If Ascan(aNF,cNF) = 0 
						aSaldo[4]+= (SD1->D1_TOTAL - SD1->D1_VALDESC)
						aadd(aNF,cNF)
					EndIf
				EndIf
				
				SD1->(dbSkip())
			EndDo
		EndIf
		DbSelectArea(cAliasSB6)
		DbSkip()
	EndDo

	dbSelectArea(cAliasSB6)
	dbCloseArea()
	dbSelectArea("SB6")

EndIf
//
// Calculo do valor unitario
//
aSaldo[3] := A410Arred(If(aSaldo[1]==0,aSaldo[3],Round(aSaldo[3]/aSaldo[1],TamSX3("D2_PRCVEN")[2])),"D2_PRCVEN")

RestArea(aArqSF4)
RestArea(aArqSB6)
RestArea(aArq)
Return(aSaldo)

